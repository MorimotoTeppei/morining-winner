<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœæ´»ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚° - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
    }

    .stat-card h3 {
      color: #666;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .stat-card .value {
      font-size: 2.5rem;
      font-weight: bold;
      color: #667eea;
    }

    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .chart-container h2 {
      margin-bottom: 20px;
      color: #333;
    }

    .ranking-table {
      width: 100%;
      border-collapse: collapse;
    }

    .ranking-table th,
    .ranking-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    .ranking-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #666;
    }

    .ranking-table tr:hover {
      background: #f8f9fa;
    }

    .rank-badge {
      display: inline-block;
      width: 30px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      border-radius: 50%;
      font-weight: bold;
      color: white;
    }

    .rank-1 { background: gold; color: #333; }
    .rank-2 { background: silver; color: #333; }
    .rank-3 { background: #cd7f32; }
    .rank-other { background: #999; }

    .heatmap {
      overflow-x: auto;
      margin-top: 20px;
    }

    .heatmap-cell {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin: 2px;
      border-radius: 3px;
      transition: transform 0.2s;
    }

    .heatmap-cell:hover {
      transform: scale(1.5);
      z-index: 10;
    }

    .loading {
      text-align: center;
      padding: 50px;
      color: white;
      font-size: 1.2rem;
    }

    .error {
      background: #ff4444;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸŒ… æœæ´»ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°</h1>
      <p>ã¿ã‚“ãªã®é ‘å¼µã‚Šã‚’å¯è¦–åŒ–ã—ã‚ˆã†ï¼</p>
    </div>

    <div id="loading" class="loading">
      ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
    </div>

    <div id="dashboard" style="display: none;">
      <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>ç·ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</h3>
          <div class="value" id="totalSessions">0</div>
        </div>
        <div class="stat-card">
          <h3>å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼æ•°</h3>
          <div class="value" id="totalUsers">0</div>
        </div>
        <div class="stat-card">
          <h3>ç·æ´»å‹•æ™‚é–“</h3>
          <div class="value" id="totalHours">0h</div>
        </div>
        <div class="stat-card">
          <h3>å¹³å‡å‚åŠ æ™‚é–“</h3>
          <div class="value" id="avgMinutes">0åˆ†</div>
        </div>
      </div>

      <!-- æ—¥åˆ¥å‚åŠ æ™‚é–“ã‚°ãƒ©ãƒ• -->
      <div class="chart-container">
        <h2>ğŸ“ˆ æ—¥åˆ¥å‚åŠ æ™‚é–“ã®æ¨ç§»</h2>
        <canvas id="dailyChart"></canvas>
      </div>

      <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
      <div class="chart-container">
        <h2>ğŸ† å‚åŠ æ™‚é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
        <table class="ranking-table">
          <thead>
            <tr>
              <th>é †ä½</th>
              <th>ãƒ¡ãƒ³ãƒãƒ¼</th>
              <th>ç·æ™‚é–“</th>
              <th>ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</th>
              <th>å‚åŠ æ—¥æ•°</th>
              <th>å¹³å‡æ™‚é–“/å›</th>
            </tr>
          </thead>
          <tbody id="rankingBody"></tbody>
        </table>
      </div>

      <!-- ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— -->
      <div class="chart-container">
        <h2>ğŸ”¥ æ´»å‹•ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</h2>
        <div id="heatmapContainer" class="heatmap"></div>
      </div>
    </div>
  </div>

  <script>
    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadDashboard() {
      google.script.run
        .withSuccessHandler(displayStatistics)
        .withFailureHandler(showError)
        .getStatistics();
    }

    function displayStatistics(stats) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';

      // çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã®æ›´æ–°
      document.getElementById('totalSessions').textContent = stats.totalSessions;
      document.getElementById('totalUsers').textContent = stats.totalUsers;

      const totalMinutes = stats.ranking.reduce((sum, user) => sum + user.totalMinutes, 0);
      document.getElementById('totalHours').textContent = (totalMinutes / 60).toFixed(1) + 'h';
      document.getElementById('avgMinutes').textContent =
        Math.round(totalMinutes / stats.totalSessions) + 'åˆ†';

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
      const rankingBody = document.getElementById('rankingBody');
      rankingBody.innerHTML = '';

      stats.ranking.forEach((user, index) => {
        const row = document.createElement('tr');
        const rank = index + 1;
        const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';

        row.innerHTML = `
          <td><span class="rank-badge ${rankClass}">${rank}</span></td>
          <td><strong>${user.name}</strong></td>
          <td>${user.totalHours}æ™‚é–“</td>
          <td>${user.sessionCount}å›</td>
          <td>${user.uniqueDays}æ—¥</td>
          <td>${user.avgMinutes}åˆ†</td>
        `;
        rankingBody.appendChild(row);
      });

      // æ—¥åˆ¥ã‚°ãƒ©ãƒ•ã®ä½œæˆ
      createDailyChart(stats.dailyData);

      // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®èª­ã¿è¾¼ã¿
      loadHeatmap();
    }

    function createDailyChart(dailyData) {
      const ctx = document.getElementById('dailyChart').getContext('2d');

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: dailyData.map(d => d.date),
          datasets: [{
            label: 'å‚åŠ æ™‚é–“ï¼ˆåˆ†ï¼‰',
            data: dailyData.map(d => d.totalMinutes),
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true,
          }, {
            label: 'å‚åŠ äººæ•°',
            data: dailyData.map(d => d.uniqueUsers),
            borderColor: '#764ba2',
            backgroundColor: 'rgba(118, 75, 162, 0.1)',
            tension: 0.4,
            yAxisID: 'y1',
          }]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              grid: {
                drawOnChartArea: false,
              },
            },
          }
        }
      });
    }

    function loadHeatmap() {
      google.script.run
        .withSuccessHandler(displayHeatmap)
        .getHeatmapData();
    }

    function displayHeatmap(heatmapData) {
      const container = document.getElementById('heatmapContainer');
      container.innerHTML = '';

      Object.entries(heatmapData).forEach(([user, dates]) => {
        const userRow = document.createElement('div');
        userRow.style.marginBottom = '10px';

        const label = document.createElement('strong');
        label.textContent = user + ': ';
        userRow.appendChild(label);

        const allDates = Object.keys(dates).sort();

        allDates.forEach(date => {
          const minutes = dates[date];
          const cell = document.createElement('div');
          cell.className = 'heatmap-cell';
          cell.title = `${date}: ${minutes}åˆ†`;

          const intensity = Math.min(minutes / 60, 1);
          cell.style.backgroundColor = `rgba(102, 126, 234, ${intensity})`;

          userRow.appendChild(cell);
        });

        container.appendChild(userRow);
      });
    }

    function showError(error) {
      document.getElementById('loading').innerHTML =
        `<div class="error">âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</div>`;
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    window.onload = loadDashboard;
  </script>
</body>
</html>
