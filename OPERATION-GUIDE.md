# 運用ガイド - Morning Winner Bot

## 完全自動化されたシステム

このシステムは以下の堅牢化により、完全自動化を実現しています。

## 実装済みの堅牢化機能

### 1. リトライ機能
- Sheetsへの書き込みに失敗した場合、最大3回まで自動リトライ
- 指数バックオフ（2秒、4秒、8秒）で待機
- ネットワークの一時的な問題を自動的に解決

### 2. ローカルバックアップ
- 書き込みに失敗した場合、`logs/failed-logs.json`に自動保存
- 後で復旧可能

### 3. 詳細ログ
- すべてのvoiceStateUpdateイベントを記録
- エラー時には詳細な情報を記録
- トラブルシューティングが容易

### 4. ヘルスチェック
- 1時間ごとにBotの状態を自動的にログ出力
- Botが正常に動作しているか確認できる

### 5. 自動再接続
- Discordとの接続が切れた場合、自動的に再接続
- ネットワークの問題を自動的に解決

## 日常の運用

### 通常時
- **何もする必要はありません**
- Botが自動的にログを記録します

### ログの確認
```bash
# リアルタイムでログを確認
tail -f logs/out.log

# 最新100行を確認
tail -100 logs/out.log

# エラーログを確認
cat logs/error.log
```

### ヘルスチェック
ログに以下のようなメッセージが1時間ごとに出力されます：
```
💚 ヘルスチェック: Botは正常に動作しています (2025-12-20 10:00:00)
   現在のアクティブユーザー数: 2
```

## トラブルシューティング

### 問題1: ログが記録されない

**確認事項:**
1. Botが動作しているか確認
```bash
ps aux | grep "node.*bot.js" | grep -v grep
```

2. ログを確認してエラーがないか確認
```bash
tail -50 logs/out.log
cat logs/error.log
```

3. 失敗したログがないか確認
```bash
cat logs/failed-logs.json
```

**解決方法:**
- 失敗したログがある場合、復旧スクリプトを実行
```bash
node retry-failed-logs.js
```

### 問題2: Botがクラッシュした

**解決方法:**
1. Botを再起動
```bash
# PM2を使用している場合
pm2 restart morning-winner-bot

# 手動で起動している場合
nohup node bot.js > logs/out.log 2>&1 &
```

### 問題3: 一部のログが欠けている

**原因:**
- Botが一時的にダウンしていた
- Discordとの接続が切れていた
- Discord APIのイベントが取りこぼされた

**解決方法:**
1. カールボットのログと照合
2. 欠けているログを手動で挿入

```bash
# fix-missing-logs.jsを編集して、欠けているログを追加
# 例:
const missingLogs = [
  {
    userId: '1362249234530959582',
    username: 'haruka_5555._43979',
    displayName: 'Haruka',
    joinTime: '2025-12-20 07:00:00',
    leaveTime: '2025-12-20 08:00:00',
  },
];

# 実行
node fix-missing-logs.js
```

### 問題4: GASダッシュボードにデータが反映されない

**原因:**
- GASのWebアプリがキャッシュしている

**解決方法:**
1. GASを再デプロイ
   - スプレッドシートで Extensions → Apps Script
   - Deploy → Manage deployments
   - 鉛筆アイコンをクリック
   - Version を「New version」に変更
   - Deploy

2. ブラウザのキャッシュをクリア
   - Cmd+Shift+R（Mac）またはCtrl+Shift+R（Windows）

## 定期メンテナンス

### 毎週
- ログファイルのサイズを確認
```bash
ls -lh logs/
```

- 古いログを削除（任意）
```bash
# 30日以前のログを削除
find logs/ -name "*.log" -mtime +30 -delete
```

### 毎月
- スプレッドシートのデータ量を確認
- 必要に応じてアーカイブ

## システムテスト

システムが正常に動作しているか確認：
```bash
node test-system.js
```

## 便利なスクリプト

### 1. 欠けているログを挿入
```bash
node fix-missing-logs.js
```

### 2. 失敗したログを復旧
```bash
node retry-failed-logs.js
```

### 3. システムテスト
```bash
node test-system.js
```

## 改善ポイント

このシステムは以下の点で改善されました：

1. **自動リトライ** - 一時的なネットワーク問題を自動的に解決
2. **ローカルバックアップ** - データの損失を防ぐ
3. **詳細ログ** - トラブルシューティングが容易
4. **ヘルスチェック** - Botの状態を定期的に確認
5. **自動再接続** - Discordとの接続問題を自動的に解決

## サポート

問題が発生した場合：
1. ログを確認（`tail -100 logs/out.log`）
2. エラーメッセージを確認
3. このガイドのトラブルシューティングセクションを参照
4. 必要に応じて手動でログを挿入

---

**完全自動化を実現！** 🎉

このシステムは、ほとんどの問題を自動的に解決します。
日常的には何もする必要はありません。
